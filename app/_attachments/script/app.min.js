var _pl={db:"peoples-lib",design:"peoples-lib"};window.URL=window.URL||window.webkitURL;var PeoplesLibApp=angular.module("PeoplesLibApp",["CornerCouch"]).config(["$compileProvider",function(n){var o=/^\s*(https?|blob):/;n.aHrefSanitizationWhitelist(o),n.imgSrcSanitizationWhitelist(o)}]);PeoplesLibApp.controller("ListingCtrl",["$scope","$http","cornercouch",function(n,o,i){function e(){n.localDb.query(a.design+"/media",{reduce:!1,limit:10,include_docs:!0,attachments:!0},function(o,i){n.$apply(function(){n.localMedias=i.rows.map(t(!0)).map(c)})})}function c(o){return o._attachments&&angular.forEach(o._attachments,function(i,e){/^cover\./.test(e)?o._local?n.localDb.getAttachment(o._id,e).then(function(i){n.$apply(function(){o.coverImg=window.URL.createObjectURL(i)})}):o.coverImg="/"+a.db+"/"+o._id+"/"+e:(o.media=i,o._local?n.localDb.getAttachment(o._id,e).then(function(i){n.$apply(function(){o.media.url=window.URL.createObjectURL(i)})}):o.media.url="/"+a.db+"/"+o._id+"/"+e)}),o}function t(n){return function(o){var i=o.doc;return i._local=n,i}}var a=window._pl;n.db=i().getDB(a.db),n.localDb=new PouchDB(a.db),n.localDb.get("_design/peoples-lib",function(o,i){i?e():n.localDb.replicate.from(window.location.origin+"/"+a.db,{doc_ids:"_design/"+a.design},e)}),n.sync=function(o){o.__loading=!0,n.localDb.replicate.from(window.location.origin+"/"+a.db,{doc_ids:[o._id]},function(){e(),o.__loading=!1})},n.remove=function(o){o.__loading=!0,n.localDb.allDocs(function(i,c){var t=c.rows.map(function(n){return n.id}).filter(function(n){return n!==o._id}),l=new PouchDB("tmp");l.replicate.from(n.localDb,{doc_ids:t},function(){n.localDb.destroy(function(){n.localDb=new PouchDB(a.db),n.localDb.replicate.from(l,function(){l.destroy(),e()})})})})},n.upload=function(o){for(var i,e=[],c=0;i=o.files[c];c++)e.push(i);e.forEach(function(o){var i=n.db.newDoc({name:o.name,content_type:o.type});i.save().success(function(){i.attach(o,o.name)})})},n.db.query(a.design,"media",{reduce:!1,limit:10,include_docs:!0}).success(function(o){n.medias=o.rows.map(t()).map(c)})}]);