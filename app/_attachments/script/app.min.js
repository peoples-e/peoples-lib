var _pl={db:"peoples-lib",design:"peoples-lib"},PeoplesLibApp=angular.module("PeoplesLibApp",["CornerCouch"]);PeoplesLibApp.controller("ListingCtrl",["$scope","$http","cornercouch",function(o,n,e){function c(){o.localDb.query(l.design+"/media",{reduce:!1,limit:10,include_docs:!0},function(n,e){o.$apply(function(){o.localMedias=e.rows.map(i)})})}function i(o){var n=o.doc;return n._attachments&&angular.forEach(n._attachments,function(o,e){/^cover\./.test(e)?n.coverImg="/"+l.db+"/"+n._id+"/"+e:(n.media=o,n.media.url="/"+l.db+"/"+n._id+"/"+e)}),n}var l=window._pl;o.db=e().getDB(l.db),o.localDb=new PouchDB(l.db),o.localDb.get("_design/peoples-lib",function(n,e){e?c():o.localDb.replicate.from(window.location.origin+"/"+l.db,{doc_ids:"_design/"+l.design},c)}),o.sync=function(n){n.__syncing=!0,o.localDb.replicate.from(window.location.origin+"/"+l.db,{doc_ids:[n._id]},function(){c(),n.__syncing=!1})},o.remove=function(n){o.localDb.allDocs(function(e,i){var t=i.rows.map(function(o){return o.id}).filter(function(o){return o!==n._id}),a=new PouchDB("tmp");a.replicate.from(o.localDb,{doc_ids:t},function(){o.localDb.destroy(function(){o.localDb=new PouchDB(l.db),o.localDb.replicate.from(a,function(){a.destroy(),c()})})})})},o.upload=function(n){for(var e,c=[],i=0;e=n.files[i];i++)c.push(e);c.forEach(function(n){var e=o.db.newDoc({name:n.name,content_type:n.type});e.save().success(function(){e.attach(n,n.name)})})},o.db.query(l.design,"media",{reduce:!1,limit:10,include_docs:!0}).success(function(n){o.medias=n.rows.map(i)})}]);